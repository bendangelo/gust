/* Entity Game Engine | MIT License */
(function(t){var n;n="undefined"!=typeof exports?exports:t.Gust={},"function"==typeof define&&"object"==typeof define.amd&&define.amd&&define(function(){return n}),n.$=function(t){return document.getElementById(t.substr(1))},function(){(function(t,n){"object"==typeof exports?module.exports=n(this):"function"==typeof define&&define.amd?define(function(){return n(t)}):t.Fiber=n(t)})(this,function(t){function n(t,n){var e;for(e in t)t.hasOwnProperty(e)&&(n[e]=t[e])}function e(){}var i=!1,s=Array.prototype,r=t.Fiber;return e.extend=function(t){function s(){i||(this.init.apply(this,arguments),this.init=void 0)}var r,o=this.prototype,a="function"==typeof t?t(o):t;return i=!0,r=s.prototype=new this,i=!1,r.init=function(){"function"==typeof o.init&&o.init.apply(this,arguments)},n(a,r),r.constructor=s,s.__base__=o,s.extend=s.prototype.extend||e.extend,s},e.proxy=function(t,n){var e,i,s={};1===arguments.length&&(n=t,t=n.constructor.__base__),i=function(e){return function(){return t[e].apply(n,arguments)}};for(e in t)t.hasOwnProperty(e)&&"function"==typeof t[e]&&(s[e]=i(e));return s},e.decorate=function(t){var e,i=t.constructor.__base__,r=s.slice.call(arguments,1),o=r.length;for(e=0;o>e;e++)n(r[e].call(t,i),t)},e.mixin=function(t){var e,i=t.__base__,r=s.slice.call(arguments,1),o=r.length;for(e=0;o>e;e++)n(r[e](i),t.prototype)},e.noConflict=function(){return t.Fiber=r,e},e})}(),n.Class=Fiber,n.Events=n.Class.extend({on:function(t,n,e){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),console.assert(n,"Event callback is null"),this._events[t].push({callback:n,context:e||this}),this},off:function(t,n){if(n){var e=this._events[t];if(e)for(var i in e)e[i].callback==n&&e.splice(i,1)}else t?this._events[t]=[]:this._events={}},trigger:function(t){if(!this._events[t])return this;for(var n,e=this._events[t],i=0,s=e.length;s>i&&(n=e[i],n);i++)n.callback.apply(n.context,Array.prototype.slice.call(arguments,1));return this},listenTo:function(){console.assert(!1)},stopListening:function(){console.assert(!1)}}),n.Scene=n.Class.extend({enter:function(){},exit:function(){},update:function(){},draw:function(){}}),n.Timer=n.Class.extend({}),n.Timer.lastTime=0,n.Timer.tick=function(){var t=Date.now(),n=this.lastTime;return this.lastTime=t,t-n},n.World=n.Class.extend({running:!1,stepSize:.03,maxTick:.05,stepProgress:0,init:function(e){e&&this.setCanvas(e),this.sceneManager=new n.SceneManager,this.groupManager=new n.GroupManager,this.requestAnimationFrame=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||t.msRequestAnimationFrame||function(n){t.setTimeout(n,1e3/60)},this._requestAnimBind=this._requestAnim.bind(this)},setCanvas:function(t){return this.canvas="string"==typeof t?n.$(t):t,this.context=this.canvas.getContext("2d"),this},start:function(){this.running||(console.assert(this.sceneManager.current,"Current scene is null"),this.running=!0,this._requestAnim())},stop:function(){return this.running=!1,this},_requestAnim:function(){this.running&&(this.requestAnimationFrame.call(t,this._requestAnimBind,this.canvas),this.run())},run:function(){var t=Math.min(n.Timer.tick()/1e3,this.maxTick);this.stepProgress+=t;for(var e=0;this.stepProgress>=this.stepSize;)if(this.sceneManager.update(),this.stepProgress-=this.stepSize,e++>10)throw"Game loop stopped, too much lag";this.sceneManager.draw()}}),n.GroupManager=n.Class.extend({init:function(){this.groups={}},add:function(){}}),n.SceneManager=n.Class.extend({current:null,init:function(){this.scenes={}},add:function(t,n){this.scenes[t]=n},enter:function(t,n){this.current&&this.current.exit(),this.current=this.scenes[t],this.current.enter(n)},update:function(){this.current.update()},draw:function(){this.current.draw()}}),n.Group=n.Class.extend({init:function(t){this.nodes=[],t&&this.add(t)},add:function(t){return this.nodes=this.nodes.concat(t),this}}),n.Node=n.Events.extend({}),n.System=n.Class.extend({init:function(t){this.group=t,this.nodes=t.nodes},processAll:function(){for(var t in this.nodes)this.process(this.nodes[t])}})})(this);