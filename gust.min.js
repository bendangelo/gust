/* Entity Game Engine | MIT License */
(function(t){var n;n="undefined"!=typeof exports?exports:t.Gust={},"function"==typeof define&&"object"==typeof define.amd&&define.amd&&define(function(){return n}),n.$=function(t){return document.getElementById(t.substr(1))},function(){(function(t,n){"object"==typeof exports?module.exports=n(this):"function"==typeof define&&define.amd?define(function(){return n(t)}):t.Fiber=n(t)})(this,function(t){function n(t,n){var e;for(e in t)t.hasOwnProperty(e)&&(n[e]=t[e])}function e(){}var i=!1,s=Array.prototype,r=t.Fiber;return e.extend=function(t){function s(){i||(this.init.apply(this,arguments),this.init=void 0)}var r,a=this.prototype,o="function"==typeof t?t(a):t;return i=!0,r=s.prototype=new this,i=!1,r.init=function(){"function"==typeof a.init&&a.init.apply(this,arguments)},n(o,r),r.constructor=s,s.__base__=a,s.extend=s.prototype.extend||e.extend,s},e.proxy=function(t,n){var e,i,s={};1===arguments.length&&(n=t,t=n.constructor.__base__),i=function(e){return function(){return t[e].apply(n,arguments)}};for(e in t)t.hasOwnProperty(e)&&"function"==typeof t[e]&&(s[e]=i(e));return s},e.decorate=function(t){var e,i,r=t.constructor.__base__,a=s.slice.call(arguments,1),o=a.length;for(e=0;o>e;e++)i="function"==typeof mixins[e]?a[e].call(t,r):mixins[e],n(i,t)},e.mixin=function(t){var e,i,r=t.__base__,a=s.slice.call(arguments,1),o=a.length;for(e=0;o>e;e++)i="function"==typeof a[e]?a[e](r):a[e],n(i,t.prototype)},e.noConflict=function(){return t.Fiber=r,e},e})}(),n.Class=Fiber,n.Events=n.Class.extend({on:function(t,n,e){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),console.assert(n,"Event callback is null"),this._events[t].push({callback:n,context:e||this}),this},off:function(t,n){if(n){var e=this._events[t];if(e)for(var i in e)e[i].callback==n&&e.splice(i,1)}else t?this._events[t]=[]:this._events={}},trigger:function(t){if(!this._events[t])return this;for(var n,e=this._events[t],i=0,s=e.length;s>i&&(n=e[i],n);i++)n.callback.apply(n.context,Array.prototype.slice.call(arguments,1));return this},listenTo:function(t,n,e){return this._listens||(this._listens=[]),t.on(n,e,this),this._listens.push({target:t,type:n,callback:e}),this},stopListening:function(){var t;for(var n in this._listens)t=this._listens[n],t.target.off(t.type,t.callback);return this}}),n.Manager=n.Events.extend({init:function(){this.items={}},add:function(t,n){return this.items[t]=n,this},get:function(t){return this.items[t]},remove:function(){}}),n.Timer=n.Class.extend({}),n.Timer.lastTime=0,n.Timer.tick=function(){var t=Date.now(),n=this.lastTime;return this.lastTime=t,t-n},n.World=n.Class.extend({running:!1,stepSize:.03,maxTick:.05,stepProgress:0,init:function(e){e&&this.setCanvas(e),this.sceneManager=new n.SceneManager,this.groupManager=new n.GroupManager,this.assetManager=new n.AssetManager,this.requestAnimationFrame=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||t.msRequestAnimationFrame||function(n){t.setTimeout(n,1e3/60)},this._requestAnimBind=this._requestAnim.bind(this)},setCanvas:function(t){return this.canvas="string"==typeof t?n.$(t):t,this.context=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this},start:function(){this.running||(console.assert(this.sceneManager.current,"Current scene is null"),this.running=!0,this._requestAnim())},stop:function(){return this.running=!1,this},_requestAnim:function(){this.running&&(this.requestAnimationFrame.call(t,this._requestAnimBind,this.canvas),this.run())},run:function(){var t=Math.min(n.Timer.tick()/1e3,this.maxTick);this.stepProgress+=t;for(var e=0;this.stepProgress>=this.stepSize;)if(this.sceneManager.update(this.stepSize),this.stepProgress-=this.stepSize,e++>10)throw"Game loop stopped, too much lag";this.sceneManager.draw(this.context)},addNode:function(t){t=[].concat(t),this.groupManager.addNode(t)}}),n.AssetManager=n.Manager.extend({add:function(t,e){return e||(e=n.AssetManager.getSrcName(t.src)),this.items[e]=t,this}}),n.AssetManager.srcName=function(t){var n=t.split("/");return n[n.length-1]},n.GroupManager=n.Manager.extend({init:function(){n.Manager.prototype.init.apply(this,arguments),this.groups={}},add:function(t,e,i){return this.groups[t]=i,n.Manager.prototype.add.call(this,t,e)},addNode:function(t){for(var n in this.items){var e=this.items[n],i=this.groups[n];i.call(this,t,e)&&e.add(t)}return this}}),n.SceneManager=n.Manager.extend({current:null,enter:function(t,n){this.current&&this.current.exit(),this.current=this.items[t],console.assert(this.current,"Scene selected is null"),this.current.enter(n)},update:function(t){this.current.update(t)},draw:function(t){this.current.draw(t)}}),n.Group=n.Events.extend({init:function(t){this.nodes=[],t&&this.add(t)},add:function(t){t=[].concat(t);for(var n in t)this.nodes.push(t[n]),this.trigger("add",t[n]);return this},remove:function(t){t=[].concat(t);for(var n in t){var e=t[n],i=this.nodes.indexOf(e);-1!=i&&(this.nodes.splice(i,1),this.trigger("remove",e))}return this},at:function(t){return this.nodes[t]},clear:function(){for(;this.nodes.length;)this.trigger("remove",this.nodes.pop());return this}}),n.Map=n.Class.extend({lengthX:0,lengthY:0,defaultValue:0,init:function(){this.clear()},clear:function(){this.map=[],this.lengthX=0,this.lengthY=0},reset:function(t){for(var n=0;this.map.length>n;n++)for(var e=0;this.map[0].length>e;e++)this.map[n][e]=void 0!==t?t:this.defaultValue;return this},copy:function(t){this.map=[];for(var n=0;t.length>n;n++){this.map[n]=Array(t.length);for(var e=0;t[0].length>e;e++)this.map[n][e]=t[n][e]}return this.lengthX=t[0].length,this.lengthY=t.length,this},set:function(t,n,e){for(;n>=this.map.length;){var i=Array(this.map[0]);for(var s in i)i[s]=this.defaultValue;this.map.push(i)}for(;t>=this.map[this.map.length-1].length;)for(var r=0;this.map.length>r;r++)t>=this.map[r].length&&this.map[r].push(this.defaultValue);return this.lengthX=this.map[n].length,this.lengthY=this.map.length,this.map[n][t]=e,this},get:function(t,n){return this.within(t,n)?this.map[n][t]:void 0},within:function(t,n){return n>=0&&this.lengthY>n&&t>=0&&this.lengthX>t}}),n.Node=n.Events.extend({init:function(){}}),n.Scene=n.Events.extend({init:function(t){this.world=t},enter:function(){},exit:function(){},update:function(){},draw:function(){}}),n.System=n.Class.extend({init:function(t){this.group=t,this.nodes=t.nodes},processAll:function(){for(var t in this.nodes)this.process(this.nodes[t])}})})(this);